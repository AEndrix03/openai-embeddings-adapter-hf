services:
  cpu:
    build:
      context: .
      dockerfile: Dockerfile.cpu
    ports:
      - "8000:8000"
    env_file:
      - .env.example
    environment:
      ADAPTER_MODEL_DEVICE: cpu
      ADAPTER_CACHE_PATH: /var/cache/adapter/embeddings_cache.sqlite3
      ADAPTER_RATE_LIMIT_ENABLED: ${ADAPTER_RATE_LIMIT_ENABLED:-false}
      ADAPTER_RATE_LIMIT_RPS: ${ADAPTER_RATE_LIMIT_RPS:-1000}
      ADAPTER_RATE_LIMIT_BURST: ${ADAPTER_RATE_LIMIT_BURST:-1000}
    volumes:
      - hf-cache:/hf-cache
      - embeddings-cache:/var/cache/adapter

  cuda:
    build:
      context: .
      dockerfile: Dockerfile.gpu
      args:
        TORCH_BASE_IMAGE: ${CUDA_TORCH_BASE_IMAGE:-pytorch/pytorch:2.4.1-cuda12.1-cudnn9-runtime}
    ports:
      - "8000:8000"
    env_file:
      - .env.example
    environment:
      ADAPTER_MODEL_DEVICE: cuda
      ADAPTER_CACHE_PATH: /var/cache/adapter/embeddings_cache.sqlite3
      ADAPTER_RATE_LIMIT_ENABLED: ${ADAPTER_RATE_LIMIT_ENABLED:-true}
      ADAPTER_RATE_LIMIT_RPS: ${ADAPTER_RATE_LIMIT_RPS:-1000}
      ADAPTER_RATE_LIMIT_BURST: ${ADAPTER_RATE_LIMIT_BURST:-1000}
    deploy:
      resources:
        reservations:
          devices:
            - capabilities: [gpu]
    volumes:
      - hf-cache:/hf-cache
      - embeddings-cache:/var/cache/adapter

  rocm6-safe:
    build:
      context: .
      dockerfile: Dockerfile.gpu
      args:
        TORCH_BASE_IMAGE: ${ROCM6_TORCH_BASE_IMAGE:-rocm/pytorch:rocm6.4_ubuntu24.04_py3.12_pytorch_release_2.4.1}
    ports:
      - "8000:8000"
    env_file:
      - .env.example
    environment:
      ADAPTER_MODEL_DEVICE: auto
      ADAPTER_CACHE_PATH: /var/cache/adapter/embeddings_cache.sqlite3
      ADAPTER_RATE_LIMIT_ENABLED: ${ADAPTER_RATE_LIMIT_ENABLED:-true}
      ADAPTER_RATE_LIMIT_RPS: ${ADAPTER_RATE_LIMIT_RPS:-1000}
      ADAPTER_RATE_LIMIT_BURST: ${ADAPTER_RATE_LIMIT_BURST:-1000}
      HSA_OVERRIDE_GFX_VERSION: ${HSA_OVERRIDE_GFX_VERSION:-}
      HIP_VISIBLE_DEVICES: ${HIP_VISIBLE_DEVICES:-0}
    volumes:
      - hf-cache:/hf-cache
      - embeddings-cache:/var/cache/adapter

  rocm6:
    build:
      context: .
      dockerfile: Dockerfile.gpu
      args:
        TORCH_BASE_IMAGE: ${ROCM6_TORCH_BASE_IMAGE:-rocm/pytorch:rocm6.4_ubuntu24.04_py3.12_pytorch_release_2.4.1}
    ports:
      - "8000:8000"
    env_file:
      - .env.example
    environment:
      ADAPTER_MODEL_DEVICE: rocm
      ADAPTER_CACHE_PATH: /var/cache/adapter/embeddings_cache.sqlite3
      ADAPTER_RATE_LIMIT_ENABLED: ${ADAPTER_RATE_LIMIT_ENABLED:-true}
      ADAPTER_RATE_LIMIT_RPS: ${ADAPTER_RATE_LIMIT_RPS:-1000}
      ADAPTER_RATE_LIMIT_BURST: ${ADAPTER_RATE_LIMIT_BURST:-1000}
      HSA_OVERRIDE_GFX_VERSION: ${HSA_OVERRIDE_GFX_VERSION:-}
      HIP_VISIBLE_DEVICES: ${HIP_VISIBLE_DEVICES:-0}
    devices:
      - /dev/kfd:/dev/kfd
      - /dev/dri:/dev/dri
    group_add:
      - video
      - render
    security_opt:
      - seccomp=unconfined
    volumes:
      - hf-cache:/hf-cache
      - embeddings-cache:/var/cache/adapter

volumes:
  hf-cache:
  embeddings-cache:
